service: uwo-eats-server

frameworkVersion: '3'

provider:
  name: aws
  stage: ${opt:stage, "dev"}
  region: ${opt:region, "ca-central-1"}
  runtime: java11
  architecture: arm64
  environment:
    JAVA_TOOL_OPTIONS: -XX:+TieredCompilation -XX:TieredStopAtLevel=1
  timeout: 20 # By default, the timeout is 6 seconds, which is too short for cold start
  httpApi:
    cors: true
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:BatchGetItem
            - dynamodb:DeleteItem
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:Query
            - dynamodb:UpdateItem
          Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/*"

package:
  artifact: build/libs/${self:service}-${self:provider.stage}-all.jar

functions:
  store-get:
    handler: uwoEats.api.storeGet.Handler
    events:
      - httpApi:
          path: /store/{storeId}
          method: get

  order-get:
    handler: uwoEats.api.orderGet.Handler
    events:
      - httpApi:
          path: /order/{storeId}/{orderId}
          method: get

  order-post:
    handler: uwoEats.api.orderPost.Handler
    events:
      - httpApi:
          path: /order/{storeId}
          method: post

resources:
  Resources:
    StoreTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-store
        AttributeDefinitions:
          - AttributeName: storeId
            AttributeType: N
        KeySchema:
          - AttributeName: storeId
            KeyType: HASH
        BillingMode: PROVISIONED
        ProvisionedThroughput:
          ReadCapacityUnits: 2
          WriteCapacityUnits: 2

    OrderTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-order
        AttributeDefinitions:
          - AttributeName: storeId
            AttributeType: N
          - AttributeName: orderId
            AttributeType: S
        KeySchema:
          - AttributeName: storeId
            KeyType: HASH
          - AttributeName: orderId
            KeyType: RANGE
        BillingMode: PROVISIONED
        ProvisionedThroughput:
          ReadCapacityUnits: 2
          WriteCapacityUnits: 2
